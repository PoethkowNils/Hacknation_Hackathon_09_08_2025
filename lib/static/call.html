<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CallCheck - Fraud Detection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .progress-bar {
      height: 6px;
      background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
    }
    .progress-fill {
      height: 100%;
      background-color: #3b82f6;
      width: 0%;
      transition: width 0.5s ease;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-6 max-w-4xl">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-blue-700">CallCheck</h1>
        <p class="text-gray-600">Real-Time Call Analysis</p>
      </div>
      <a href="calls.html" class="text-blue-600 hover:text-blue-800 flex items-center">
        <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
      </a>
    </div>

    <!-- Call Info Header -->
    <div class="bg-white rounded-lg shadow-md p-5 mb-6">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h2 class="text-xl font-semibold flex items-center">
            <span id="callStatusIcon" class="mr-2">ðŸ“ž</span>
            <span id="callStatusText">Incoming Call</span>
          </h2>
          <p class="text-gray-500 text-sm" id="callTimer">00:00</p>
        </div>
        <span id="statusBadge" class="px-3 py-1 rounded-full text-white text-sm bg-gray-500">Connecting...</span>
      </div>

      <div class="grid grid-cols-2 gap-4 mt-4">
        <div>
          <p class="text-gray-600"><strong>Caller:</strong></p>
          <p id="callerNumber" class="font-medium">+1 (555) 123-4567</p>
        </div>
        <div>
          <p class="text-gray-600"><strong>Started:</strong></p>
          <p id="startTime" class="font-medium"></p>
        </div>
      </div>
    </div>

    <!-- Risk Indicator -->
    <div class="bg-white rounded-lg shadow-md p-5 mb-6">
      <div class="flex justify-between mb-2">
        <span class="text-gray-600">Fraud Risk Level</span>
        <span id="riskLevel" class="font-medium">Analyzing...</span>
      </div>
      <div class="progress-bar rounded-full overflow-hidden">
        <div id="riskProgress" class="progress-fill"></div>
      </div>
    </div>

    <!-- Fraud Alert Banner -->
    <div id="fraudAlert" class="hidden p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg mb-6 animate-pulse-slow">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-xl mr-3"></i>
        <div>
          <strong>CRITICAL FRAUD ALERT!</strong>
          <p id="alertReason" class="mt-1"></p>
        </div>
      </div>
    </div>

    <!-- Analysis Panel -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-white p-5 rounded-lg shadow">
        <h3 class="font-semibold text-lg mb-3 flex items-center">
          <i class="fas fa-brain mr-2 text-blue-600"></i>AI Analysis
        </h3>
        <div id="reasoning" class="text-gray-700 min-h-20">Waiting for analysis...</div>
      </div>
      
      <div class="bg-white p-5 rounded-lg shadow">
        <h3 class="font-semibold text-lg mb-3 flex items-center">
          <i class="fas fa-history mr-2 text-blue-600"></i>Analysis History
        </h3>
        <div id="transcriptLog" class="h-40 overflow-y-auto text-sm"></div>
      </div>
    </div>

    <!-- Call Controls -->
    <div class="bg-white p-5 rounded-lg shadow-md flex justify-center space-x-4">
      <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
        <i class="fas fa-phone-slash mr-2"></i>End Call
      </button>
      <button class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
        <i class="fas fa-user-shield mr-2"></i>Flag as Fraud
      </button>
      <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
        <i class="fas fa-check-circle mr-2"></i>Mark as Safe
      </button>
    </div>
  </div>

  <script>
    const wsUrl = "ws://localhost:5000/client";
    let socket;
    let callTimer;

    // Get call_sid from URL
    const urlParams = new URLSearchParams(window.location.search);
    const callSid = urlParams.get('call_sid');

    // Elements
    const statusBadge = document.getElementById("statusBadge");
    const reasoningEl = document.getElementById("reasoning");
    const fraudAlert = document.getElementById("fraudAlert");
    const alertReason = document.getElementById("alertReason");
    const transcriptLog = document.getElementById("transcriptLog");
    const riskLevel = document.getElementById("riskLevel");
    const riskProgress = document.getElementById("riskProgress");
    const callerNumber = document.getElementById("callerNumber");
    const startTimeEl = document.getElementById("startTime");
    const callTimerEl = document.getElementById("callTimer");
    const callStatusIcon = document.getElementById("callStatusIcon");
    const callStatusText = document.getElementById("callStatusText");

    // Set start time
    const startTime = new Date();
    startTimeEl.textContent = startTime.toLocaleTimeString();

    // Start call timer
    let callSeconds = 0;
    callTimer = setInterval(() => {
      callSeconds++;
      const minutes = Math.floor(callSeconds / 60);
      const seconds = callSeconds % 60;
      callTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);

    function connect() {
      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        statusBadge.textContent = "Live";
        statusBadge.className = "px-3 py-1 rounded-full text-white text-sm bg-green-500";
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        // Only process events for this call
        if (data.call_sid !== callSid) return;
        
        if (data.event === "fraud_update") {
          processFraudUpdate(data);
        }
        else if (data.event === "call_ended") {
          endCall();
        }
      };

      socket.onclose = () => {
        statusBadge.textContent = "Disconnected";
        statusBadge.className = "px-3 py-1 rounded-full text-white text-sm bg-gray-500";
        setTimeout(connect, 3000);
      };

      socket.onerror = (err) => {
        console.error("WebSocket error:", err);
      };
    }

    function processFraudUpdate(data) {
      reasoningEl.textContent = `${data.reasoning} [${data.confidence}]`;
      
      // Update risk indicator
      const riskMap = {
        "low": {text: "Low Risk", width: "30%", color: "text-green-600"},
        "medium": {text: "Medium Risk", width: "60%", color: "text-yellow-600"},
        "high": {text: "High Risk", width: "90%", color: "text-orange-600"}
      };
      
      const riskInfo = riskMap[data.confidence] || riskMap.medium;
      riskLevel.textContent = riskInfo.text;
      riskLevel.className = `font-medium ${riskInfo.color}`;
      riskProgress.style.width = riskInfo.width;
      
      // Update status
      if (data.is_fraudulent) {
        statusBadge.textContent = `FRAUD: ${data.fraud_type.toUpperCase()}`;
        statusBadge.className = "px-3 py-1 rounded-full text-white text-sm bg-red-600";
        
        callStatusIcon.textContent = "ðŸš¨";
        callStatusText.textContent = "Fraud Detected!";
        callStatusText.className = "text-xl font-semibold text-red-600";
        
        alertReason.textContent = data.reasoning;
        fraudAlert.classList.remove("hidden");
      } else {
        statusBadge.textContent = "Safe";
        statusBadge.className = "px-3 py-1 rounded-full text-white text-sm bg-green-500";
        fraudAlert.classList.add("hidden");
        
        callStatusIcon.textContent = "ðŸ“ž";
        callStatusText.textContent = "In Progress";
        callStatusText.className = "text-xl font-semibold";
      }
      
      // Add to transcript
      const p = document.createElement("p");
      p.innerHTML = `<span class="font-medium">[${new Date().toLocaleTimeString()}]</span> ${data.reasoning}`;
      p.className = "py-1 border-b border-gray-100";
      transcriptLog.prepend(p);
    }

    function endCall() {
      clearInterval(callTimer);
      statusBadge.textContent = "Call Ended";
      statusBadge.className = "px-3 py-1 rounded-full text-white text-sm bg-gray-500";
      
      callStatusIcon.textContent = "ðŸ“´";
      callStatusText.textContent = "Call Ended";
      callStatusText.className = "text-xl font-semibold text-gray-600";
      
      // Disable buttons after call ends
      document.querySelectorAll("button").forEach(btn => {
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");
      });
    }

    // Initialize
    connect();

    // Simulate caller number for demo (replace with actual data)
    callerNumber.textContent = "+1 (" + Math.floor(Math.random() * 900 + 100) + ") " + 
      Math.floor(Math.random() * 900 + 100) + "-" + Math.floor(Math.random() * 9000 + 1000);
  </script>
</body>
</html>