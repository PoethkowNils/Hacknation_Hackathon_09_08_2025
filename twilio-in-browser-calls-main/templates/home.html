<!DOCTYPE html>
<html>

<head>
    <title>In browser calls</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
        crossorigin="anonymous" />
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Add custom styles for fraud alerts */
        .fraud-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alert-critical {
            background-color: #ffcccc;
            border-left: 5px solid #ff0000;
        }
        
        .alert-medium {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }
        
        .alert-low {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
        }
        
        .timestamp {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .fraud-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Fraud Alert Panel -->
        <div class="card fraud-container">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h3 class="m-0">Fraud Detection Alerts</h3>
                <button id="clearAlertsBtn" class="btn btn-sm btn-light">Clear All</button>
            </div>
            <div class="card-body p-0">
                <div id="fraud-alerts" class="list-group list-group-flush">
                    <!-- Alerts will appear here dynamically -->
                    <div class="list-group-item text-center text-muted py-4" id="no-alerts-placeholder">
                        No fraud alerts detected
                    </div>
                </div>
            </div>
        </div>

        <!-- log output -->
        <div class="card text-center log-container mt-4">
            <h3>Device log</h3>
            <div id="log"></div>
            <div class="btn-container">
                <button type="button" id="btnOpenNumberPad" class="btn btn-default btn-circle btn-lg">
                    <i class="fa fa-phone fa-flip-horizontal " aria-hidden="true" style="color: green;"></i>
                </button>
            </div>
        </div>

        <!-- Modal dial -->
        {% include 'dial_modal.html' %}

        <!-- Modal call in progress -->
        {% include 'call_in_progress_modal.html' %}

        <!-- Modal incoming call -->
        {% include 'incoming_call_modal.html' %}

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
            crossorigin="anonymous"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://media.twiliocdn.com/sdk/js/client/v1.8/twilio.min.js"></script>
        <script type="text/javascript" src="/static/js/main.js"></script>
        <script type="text/javascript" src="/static/js/modals.js" defer></script>
        
        <!-- Fraud Alert WebSocket Handler -->
        <script>
            $(document).ready(function() {
                // Connect to WebSocket server for fraud alerts
                const host = window.location.hostname;
                const port = 5000; // Match your WebSocket server port
                const fraudSocket = new WebSocket(`ws://${host}:${port}/client`);
                
                // Handle incoming fraud alerts
                fraudSocket.onmessage = (event) => {
                    const alert = JSON.parse(event.data);
                    displayFraudAlert(alert);
                    
                    // Show browser notification for critical alerts
                    if (alert.is_fraudulent && alert.confidence === 'high') {
                        showBrowserNotification(alert);
                    }
                };
                
                // Clear alerts button
                $('#clearAlertsBtn').click(function() {
                    $('#fraud-alerts').empty();
                    $('#no-alerts-placeholder').show();
                });
                
                // Display fraud alert in UI
                function displayFraudAlert(alert) {
                    // Hide placeholder if it's the first alert
                    $('#no-alerts-placeholder').hide();
                    
                    // Determine alert styling
                    let alertClass = '';
                    let icon = '';
                    
                    if (alert.is_fraudulent) {
                        switch(alert.confidence) {
                            case 'high':
                                alertClass = 'alert-critical';
                                icon = '<i class="fas fa-exclamation-triangle fraud-icon text-danger"></i>';
                                break;
                            case 'medium':
                                alertClass = 'alert-medium';
                                icon = '<i class="fas fa-exclamation-circle fraud-icon text-warning"></i>';
                                break;
                            default:
                                alertClass = 'alert-low';
                                icon = '<i class="fas fa-info-circle fraud-icon text-success"></i>';
                        }
                    } else {
                        alertClass = 'alert-low';
                        icon = '<i class="fas fa-check-circle fraud-icon text-success"></i>';
                    }
                    
                    // Format timestamp
                    const timestamp = new Date(alert.timestamp).toLocaleTimeString();
                    
                    // Create alert element
                    const alertElement = $(`
                        <div class="list-group-item ${alertClass}">
                            <div class="d-flex align-items-center">
                                ${icon}
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">${alert.is_fraudulent ? 'ðŸš¨ POTENTIAL FRAUD' : 'âœ… Safe Call'}</h5>
                                    <p class="mb-1">${alert.reasoning}</p>
                                    <div class="d-flex justify-content-between">
                                        <span class="badge bg-${alert.is_fraudulent ? 'danger' : 'success'}">
                                            ${alert.fraud_type.toUpperCase()}
                                        </span>
                                        <span class="timestamp">${timestamp}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                    
                    // Add to top of alerts container
                    $('#fraud-alerts').prepend(alertElement);
                }
                
                // Show browser notification
                function showBrowserNotification(alert) {
                    // Check if browser supports notifications
                    if (!("Notification" in window)) return;
                    
                    // Request permission if needed
                    if (Notification.permission !== "granted") {
                        Notification.requestPermission();
                    }
                    
                    // Create notification
                    if (Notification.permission === "granted") {
                        new Notification("ðŸš¨ Fraud Alert Detected", {
                            body: `${alert.fraud_type.toUpperCase()} - ${alert.reasoning}`,
                            icon: "/static/images/fraud-alert.png"
                        });
                    }
                }
            });
        </script>
</body>

</html>