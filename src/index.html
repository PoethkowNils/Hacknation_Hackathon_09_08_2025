<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Audio Stream</title>
</head>
<body>
<h1>WebRTC Audio-Stream</h1>
<button onclick="startAudioStream()">Start Streaming</button>
<button onclick="stopAudioStream()">Stop Streaming</button>
<script>
    let ws;
    let audioContext;
    let microphone;
    let recorder;

    async function startAudioStream() {
        console.log("CLIENT: Button geklickt. Versuche, WebSocket zu verbinden...");

        // Stelle sicher, dass nur eine Verbindung aktiv ist
        if (ws && ws.readyState === WebSocket.OPEN) {
            console.log("CLIENT: Verbindung ist bereits offen.");
            return;
        }

        ws = new WebSocket("ws://localhost:5005");

        ws.onopen = async () => {
            console.log("CLIENT: WebSocket verbunden! ✅");

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("CLIENT: Mikrofon-Zugriff erhalten. Starte Audio-Worklet.");

                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });

                // Lade den AudioWorklet-Prozessor
                await audioContext.audioWorklet.addModule('recorder-processor.js');

                microphone = audioContext.createMediaStreamSource(stream);
                recorder = new AudioWorkletNode(audioContext, 'recorder-processor');

                recorder.port.onmessage = event => {
                    if (ws.readyState === WebSocket.OPEN) {
                        // Sende die rohen Audiodaten direkt an den Server
                        ws.send(event.data);
                        console.log(`CLIENT: Sende rohen Audio-Chunk der Größe: ${event.data.byteLength} Bytes.`);
                    }
                };

                microphone.connect(recorder);
                recorder.connect(audioContext.destination);

            } catch (error) {
                console.error('CLIENT: Zugriff auf Mikrofon verweigert oder Fehler bei Audio-Worklet:', error);
            }
        };

        ws.onclose = () => {
            console.log("CLIENT: WebSocket geschlossen.");
            cleanup();
        };

        ws.onerror = (error) => {
            console.error("CLIENT: WebSocket-Fehler:", error);
            cleanup();
        };
    }

    function stopAudioStream() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
            console.log("CLIENT: Stop-Button geklickt. WebSocket wird geschlossen.");
        }
    }

    function cleanup() {
        if (recorder) {
            recorder.disconnect();
        }
        if (microphone) {
            microphone.disconnect();
        }
        if (audioContext) {
            audioContext.close();
        }
    }
</script>
</body>
</html>